
<!doctype html>
<html>

<head>
	<title>Serial Plotter</title>
	<link href="bootstrap.min.css" rel="stylesheet">
	<script src="Chart.bundle.js"></script>
	<script src="utils.js"></script>
	<script src="canvas2image.js"></script>
	<style>
	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	
	.list-group-item, .list-group {
		width: 100%;
	}
	</style>
</head>

<body>
	<div class="container">
		<div class="row">
			<canvas id="canvas"></canvas>
		</div>
		<div class="row">
			<div class="col-md-3 offset-md-1">
				<button type="button" class="btn btn-primary btn-lg btn-block" onclick="scan()" id="scanButton">Connect</button>
				<center><span id="connectionStatus">Disconnected</span></center>
			</div>
			<div class="col-md-3 ">
				<button type="button" class="btn btn-secondary btn-lg btn-block" onclick="addDataset()" id="datasetButton">Add Dataset</button>
				<ul id="datasets" class="list-group"></ul>
			</div>
			<div class="col-md-3">
				<button type="button" class="btn btn-success btn-lg btn-block" onclick="save()">Save</button>
			</div>
		</div>
	</div>
	<div id="img-out"></div>
	<script>
//require modules
const {desktopCapturer, screen} = require('electron');
const prompt = require('electron-prompt');
const SerialPort = require('serialport');

//variables
var xAxis = [0];
var datasets = [];
var dataOngoing = "";
var alerted = [false,false,false];

//document ready
window.onload = function(e){ 
    plot();
}

//objects
var canvas = document.getElementById("canvas");

function plot()
{
	var ctx = canvas.getContext('2d');
	window.myChart = new Chart(ctx, {
		type: 'line',
		data: {
			labels: xAxis,
			datasets: datasets
		},
		options: {
			scales: {
				xAxes: [{
					ticks: {
						display: false
					}
				}]
			},
			elements: {
				point:{
					radius: 0
				}
			}
		}
	});
}

function scan()
{
	//scan open ports
	SerialPort.list((err, ports) => {
		if (err) {
			alert("Error getting ports: " + err);
		}
		
		else if (ports.length === 0) {
			alert("No open ports");
		}
		
		else {
			//loop through ports
			ports.forEach(function(element) {
				//ask for connection
				if (confirm("Use " + element["comName"] + "?")) {
					//get baud rate
					prompt({
						title: 'Set Baudrate',
						label: 'Baudrate:',
						value: '9600'
					})
					.then((baudRate) => {
						if(baudRate === null) {
							console.log('Cancelled');
						} else {
							//connect to port
							window.port = new SerialPort(element["comName"], {
								baudRate: parseInt(baudRate)
							});

							//on open
							port.on('open', function() {
								alert('Connected to serialport');
								document.getElementById("connectionStatus").innerHTML = "Connected";
							});

							//on error
							port.on('error', function(err) {
								alert('Error from serialport: ', err.message);
							})
							
							//on data
							port.on('data', function (data) {
								combineData(data);
							});
							
							//on close
							port.on('close', function () {
								alert("Serialport disconnected");
								document.getElementById("connectionStatus").innerHTML = "Disconnected";
							});
						}
					})
					.catch(console.error);
					return;
				}
			});
		}
	});
}

function combineData(data)
{
	dataOngoing += data;
	if (data.indexOf(";") != -1)
	{
		handleData(dataOngoing.slice(0, -1));
		dataOngoing = "";
	}
}

function handleData(data)
{
	console.log('data: ' + data);
	//check that we've added datasets
	if (datasets.length > 0)
	{
		alerted[3] = false;
		//count datapoints
		if (data.indexOf(",") == -1)
		{
			if (!alerted[0])
			{
				alert("No data breakpoints (,)");
				alerted[0] = true;
			}
			console.log("No data breakpoints (,)");
		}
		else
		{
			//split by delimiter
			datapoints = data.split(",");
			//check if the count of datapoints matches the datasets
			if (datapoints.length-1 == datasets.length)
			{
				alerted[1] = false;
				shift = false;
				//push last item as xAxis
				xAxis.push(datapoints[datapoints.length-1]);
				//limit the data in the chart
				if (xAxis.length > 300)
				{
					xAxis.shift();
					shift = true;
				}
				//add datapoints to the datasets
				for (var i = 0; i < datapoints.length-1; i++)
				{
					datasets[i].data.push(datapoints[i]);
					//limit the data in the chart
					if (shift)
					{
						datasets[i].data.shift();
					}
				}
				//update chart
				window.myChart.update();
			}
			else
			{
				if (!alerted[1])
				{
					alert("Datapoints count does not match the breakpoins count");
					alerted[1] = true;
				}
				console.log("Datapoints count does not match the breakpoins count");
			}
		}
	}
	else
	{
		if (!alerted[3])
		{
			alert("No datasets");
			alerted[3] = true;
		}
		console.log("No datasets");
	}
}

function randomColor() {
	var r = Math.floor(Math.random() * 255);
	var g = Math.floor(Math.random() * 255);
	var b = Math.floor(Math.random() * 255);
	return "rgb(" + r + "," + g + "," + b + ")";
};

function addDataset()
{
	prompt({
		title: 'New Dataset',
		label: 'Dataset Name:'
	})
	.then((label) => {
		if(label === null) {
			console.log('Cancelled');
		} else {
			//check if the label is already taken
			for (var i = 0; i < datasets.length; i++)
			{
				if (datasets[i].label == label)
				{
					alert("Dataset name is already in use. Please use a different one.");
					return;
				}
			}
			//check for an empty name
			if (label == "")
			{
				alert("Dataset name can not be empty");
				return;
			}
			//set color 
			var color = randomColor();
			//push to datasets
			datasets.push({label: label, data: [0], backgroundColor: color, borderColor: color, fill: false});
			//create list item and push to list
			var node = document.createElement("LI");
			var datasetsNode = document.getElementById("datasets");
			node.innerHTML = label + ' (<a onclick="removeDataset(this,\'' + label + '\')" style="color:red;cursor:pointer">X</a>)';
			node.className = "list-group-item";
			datasetsNode.appendChild(node);
			//update chart
			window.myChart.update();
		}
	})
	.catch(console.error);
}

function removeDataset(ev,label)
{	
	var id = 0;
	
	//get dataset id
	for (var i = 0; i < datasets.length; i++)
	{
		if (datasets[i].label == label)
		{
			id = i;
		}
	}
	//remove from list 
	ev.parentNode.parentNode.removeChild(ev.parentNode);
	//clear array if it's the only element
	if (datasets.length == 1)
	{
		datasets = [];
		window.myChart.data.datasets = datasets;
	}
	//remove from datasets
	else
	{
		datasets.splice(id,1);
	}
	//update chart
	window.myChart.update();
}

function save()
{	
	Canvas2Image.saveAsPNG(canvas,canvas.width,canvas.height,"png"); 
}
	</script>
</body>

</html>
